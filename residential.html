<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>טופס לקוח ביתי</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <img src="logo.JPG" alt="לוגו">
    </div>
      <button type="button" onclick="chooseExcel()" class="choose-excel">בחר קובץ אקסל</button>

    <h2>טופס לקוח ביתי</h2>
    <form id="residentialForm">
      <!-- השדות שלך, ללא שינוי -->
      <div class="card">
        <div class="label">שם מתרים</div><input class="field" name="שם מתרים">
      </div>
      <div class="card">
        <div class="label">שם פרטי</div><input class="field" name="שם פרטי">
      </div>
      <div class="card">
        <div class="label">שם משפחה</div><input class="field" name="שם משפחה">
      </div>
      <div class="card">
        <div class="label">ת.ז.</div><input class="field" name="ת.ז.">
      </div>
      <div class="card">
        <div class="label">נייד</div><input class="field" name="נייד">
      </div>
      <div class="card">
        <div class="label">מייל</div><input class="field" name="מייל">
      </div>
      <div class="card">
        <div class="label">ועד בית:</div>
        <div class="radio-group">
          <label><input type="radio" name="vaad" value="כן"> כן</label>
          <label><input type="radio" name="vaad" value="לא"> לא</label>
        </div>

      </div>
      <div class="card">
        <div class="label">עיר</div><input class="field" name="עיר">
      </div>
      <div class="card">
        <div class="label">רחוב</div><input class="field" name="רחוב">
      </div>
      <div class="card">
        <div class="label">בנין</div><input class="field" name="בנין">
      </div>
      <div class="card">
        <div class="label">דירה</div><input class="field" name="דירה">
      </div>
      <div class="card">
        <div class="label">כניסה</div><input class="field" name="כניסה">
      </div>
      <div class="card">
        <div class="label">קומה</div><input class="field" name="קומה">
      </div>
      <div class="card">
        <div class="label">מספר חוזה</div><input class="field" name="מספר חוזה">
      </div>
      <div class="card">
        <div class="label">מספר מונה</div><input class="field" name="מספר מונה">
      </div>
      <div class="card">
        <div class="label">סוג תעריף:</div>
        <div class="radio-group">
          <input type="radio" id="tariffA" name="tariff" value="א">
          <label for="tariffA">א</label>

          <input type="radio" id="tariffB" name="tariff" value="ב">
          <label for="tariffB">ב</label>

          <input type="radio" id="tariffC" name="tariff" value="ג">
          <label for="tariffC">ג</label>
        </div>

      </div>
      <div class="card">
        <div class="label">שם בן הזוג</div><input class="field" name="שם בן הזוג">
      </div>

      <button type="button" onclick="appendToExcel()">שמור</button>
    </form>

    <!-- הודעת פופאפ -->
    <div id="popup" class="popup hidden" tabindex="0">
      <p id="popupText"></p>
      <button onclick="closePopup()">אישור</button>
    </div>
  </div>

  <script>
    let excelFileHandle;

    function showPopup(message) {
      const popup = document.getElementById("popup");
      document.getElementById("popupText").innerText = message;
      popup.classList.remove("hidden");
      popup.focus(); // מעביר פוקוס לפופאפ
    }

    function closePopup() {
      document.getElementById("popup").classList.add("hidden");
    }

    // מאזין ללחיצה על אנטר כשפופאפ פתוח
    document.getElementById("popup").addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        closePopup();
      }
    });


    async function chooseExcel() {
      try {
        [excelFileHandle] = await window.showOpenFilePicker({
          types: [{
            description: 'Excel Files',
            accept: {
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
            }
          }]
        });
        showPopup("הקובץ נבחר בהצלחה");
      } catch (err) {
        showPopup("בחירת קובץ בוטלה");
      }
    }

    async function appendToExcel() {
      try {
        if (!excelFileHandle) {
          showPopup("יש לבחור קובץ קודם");
          return;
        }

        const file = await excelFileHandle.getFile();
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const existingData = XLSX.utils.sheet_to_json(worksheet);

        const form = document.getElementById("residentialForm");
        const data = {};
        [...form.elements].forEach(el => {
          if (el.name) data[el.name] = el.value.trim() || "חסר";
        });

        existingData.push(data);
        const newSheet = XLSX.utils.json_to_sheet(existingData, { header: Object.keys(data) });
        workbook.Sheets[sheetName] = newSheet;

        const updatedArrayBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
        const writable = await excelFileHandle.createWritable();
        await writable.write(updatedArrayBuffer);
        await writable.close();

        form.reset(); // איפוס הטופס
        showPopup("השמירה בוצעה בהצלחה");
      } catch (err) {
        if (err.name === "InvalidStateError") {
          showPopup("לא ניתן לשמור לקובץ כשהוא פתוח ב־Excel. נא לסגור את הקובץ ולנסות שוב.");
        } else {
          showPopup("שגיאה בשמירה: " + err.message);
        }
      }
    }
  </script>
</body>

</html>