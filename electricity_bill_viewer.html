<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>צפייה בחשבון חשמל</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f7;
      padding: 40px;
    }

    .container {
      max-width: 650px;
      margin: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
    }

    input[type="file"] {
      width: 100%;
      margin-bottom: 15px;
    }

    .card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px 18px;
      margin-bottom: 12px;
      border-right: 5px solid #4f46e5;
    }

    .label {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .field {
      width: 100%;
      font-size: 18px;
      font-weight: bold;
      border: none;
      background: transparent;
      outline: none;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #4f46e5;
      color: white;
      cursor: pointer;
      margin-top: 15px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>פרטי חשבון חשמל</h1>

    <input type="file" id="pdfInput" accept="application/pdf">

    <div class="card">
      <div class="label">שם העמותה</div><input class="field" id="name">
    </div>
    <div class="card">
      <div class="label">מספר העמותה</div><input class="field" id="association">
    </div>
    <div class="card">
      <div class="label">כתובת מלאה</div><input class="field" id="address">
    </div>
    <div class="card">
      <div class="label">מספר חשבון חוזה</div><input class="field" id="contract">
    </div>
    <div class="card">
      <div class="label">מספר מונה</div><input class="field" id="meter">
    </div>
    <div class="card">
      <div class="label">תעו״ז / רגיל</div><input class="field" id="tariff">
    </div>

    <div class="card">
      <div class="label">טלפון</div><input class="field" id="phone">
    </div>
    <div class="card">
      <div class="label">מייל</div><input class="field" id="email">
    </div>
    <div class="card">
      <div class="label">פרטי בנק</div><input class="field" id="bank">
    </div>

    <button onclick="sendEmail()">שלח מייל</button>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    document.getElementById("pdfInput").addEventListener("change", async e => {
      const buffer = await e.target.files[0].arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

      let fullText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = (await page.getTextContent()).items.map(i => i.str).join("\n");
        fullText += "\n" + text;
      }

      const lines = fullText.split("\n");

      // שם העמותה
      const nameMatch = fullText.match(/לכבוד:\s*\n\s*(.+)/);
      const orgName = nameMatch ? nameMatch[1].trim() : "";

      document.getElementById("name").value = orgName;

      // מספר עמותה
      document.getElementById("association").value =
        fullText.match(/עמותה\s*(\d+)/)?.[1] || "";
// חילוץ כתובת: שתי שורות לא ריקות אחרי שם העמותה
let addressLines = [];

for (let i = 0; i < lines.length; i++) {
  if (lines[i].trim() === orgName) {
    let j = i + 1;

    while (j < lines.length && addressLines.length < 2) {
      const line = lines[j].trim();
      if (line !== "") {
        addressLines.push(line);
      }
      j++;
    }

    break;
  }
}

document.getElementById("address").value = addressLines.join(" ");



      // מספר חוזה
      document.getElementById("contract").value =
        fullText.match(/מספר חשבון חוזה:\s*(\d+)/)?.[1] || "";

      // מספר מונה
      document.getElementById("meter").value =
        fullText.match(/מונה מספר:\s*(\d+)/)?.[1] || "";

      // תעו"ז / רגיל
      document.getElementById("tariff").value =
        /סוג הלקוח[\s\S]*?תעו/.test(fullText) ? 'תעו"ז' : 'רגיל';
    });

    function sendEmail() {
      const subject = encodeURIComponent("נתוני חשבון חשמל");
      const body = encodeURIComponent(
        `שם עמותה: ${name.value}
מספר עמותה: ${association.value}
כתובת: ${address.value}
מספר חוזה: ${contract.value}
מספר מונה: ${meter.value}
תעריף: ${tariff.value}

טלפון: ${phone.value}
מייל: ${email.value}
בנק: ${bank.value}`
      );

      window.open(
        `https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`,
        "_blank"
      );
    }
  </script>

</body>

</html>