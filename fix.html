<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>תיקון נתוני לקוח</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="logo3.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body onload="switchTab('residential')">
  <div class="container">
    <div class="header"><img src="logo.JPG" alt="לוגו"></div>

    <div class="tabs">
      <button id="tabBtnResidential" class="tab-button active-tab" onclick="switchTab('residential')">לקוח ביתי</button>
      <button id="tabBtnBusiness" class="tab-button" onclick="switchTab('business')">לקוח עסקי</button>
      <button id="tabBtnInterested" class="tab-button" onclick="switchTab('interested')">לקוח מתעניין</button>
      <button id="tabBtnAffiliated" class="tab-button" onclick="switchTab('affiliated')">לקוח מצורף</button>
    </div>

    <div id="residentialTab">
      <button type="button" onclick="chooseExcelResidential()" class="choose-excel">בחר קובץ אקסל</button>
      <div class="search-wrapper"><input type="text" id="searchInputResidential" class="field" placeholder="חפש לפי שם פרטי או משפחה"
        oninput="filterClients('residential')"></div>
      <div class="client-list-wrapper"><select id="clientListResidential" class="client-select" size="5"
          onchange="loadClientData('residential')"></select></div>
      <form id="clientFormResidential"></form>
      <button id="saveBtnResidential" type="button" onclick="saveChanges('residential')">שמור שינויים</button>
    </div>

    <div id="businessTab" class="hidden">
      <button type="button" onclick="chooseExcelBusiness()" class="choose-excel">בחר קובץ אקסל</button>
      <button type="button" onclick="chooseBusinessFolder()" class="choose-excel">בחר תיקיית שמירה</button>
      <div class="search-wrapper"><input type="text" id="searchInputBusiness" class="field" placeholder="חפש לפי שם חברה או חפ"
        oninput="filterClients('business')"></div>
      <div class="client-list-wrapper"><select id="clientListBusiness" class="client-select" size="5"
          onchange="loadClientData('business')"></select></div>
      <form id="clientFormBusiness"></form>
      <button id="saveBtnBusiness" type="button" onclick="saveChanges('business')">שמור שינויים</button>
    </div>

    <div id="interestedTab" class="hidden">
      <button type="button" onclick="chooseExcelInterested()" class="choose-excel">בחר קובץ אקסל</button>
      <div class="search-wrapper"><input type="text" id="searchInputInterested" class="field" placeholder="חפש לפי שם"
        oninput="filterClients('interested')"></div>
      <div class="client-list-wrapper"><select id="clientListInterested" class="client-select" size="5"
          onchange="loadClientData('interested')"></select></div>
      <form id="clientFormInterested"></form>
      <button id="saveBtnInterested" type="button" onclick="saveChanges('interested')">שמור שינויים</button>
    </div>

    <div id="affiliatedTab" class="hidden">
      <button type="button" onclick="chooseExcelAffiliated()" class="choose-excel">בחר קובץ אקסל</button>
      <div class="search-wrapper"><input type="text" id="searchInputAffiliated" class="field" placeholder="חפש לפי שם חברה"
        oninput="filterClients('affiliated')"></div>
      <div class="client-list-wrapper"><select id="clientListAffiliated" class="client-select" size="5"
          onchange="loadClientData('affiliated')"></select></div>
      <form id="clientFormAffiliated"></form>
      <button id="saveBtnAffiliated" type="button" onclick="saveChanges('affiliated')">שמור שינויים</button>
    </div>

    <div id="popup" class="popup hidden" tabindex="0">
      <p id="popupText"></p>
      <button onclick="closePopup()">אישור</button>
    </div>
  </div>

  <script>
    let workbookResidential, selectedIndexResidential;
    let workbookBusiness, selectedIndexBusiness;
    let workbookInterested, selectedIndexInterested;
    let workbookAffiliated, selectedIndexAffiliated;
    let residentialFileHandle, businessFileHandle, interestedFileHandle, affiliatedFileHandle;
    let businessFolderHandle;

    function switchTab(tab) {
      ["residential", "business", "interested", "affiliated"].forEach(t => {
        document.getElementById(t + "Tab").style.display = t === tab ? 'block' : 'none';
        document.getElementById("tabBtn" + capitalize(t)).classList.toggle("active-tab", t === tab);
      });
    }

    async function chooseExcelResidential() {
      [residentialFileHandle] = await window.showOpenFilePicker();
      const file = await residentialFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookResidential = XLSX.read(data);
      populateClientList("residential", workbookResidential);
    }

    async function chooseExcelBusiness() {
      [businessFileHandle] = await window.showOpenFilePicker();
      const file = await businessFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookBusiness = XLSX.read(data);
      populateClientList("business", workbookBusiness);
    }

    async function chooseExcelInterested() {
      [interestedFileHandle] = await window.showOpenFilePicker();
      const file = await interestedFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookInterested = XLSX.read(data);
      populateClientList("interested", workbookInterested);
    }

    async function chooseExcelAffiliated() {
      [affiliatedFileHandle] = await window.showOpenFilePicker();
      const file = await affiliatedFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookAffiliated = XLSX.read(data);
      populateClientList("affiliated", workbookAffiliated);
    }

    async function chooseBusinessFolder() {
      businessFolderHandle = await window.showDirectoryPicker();
    }

    function populateClientList(type, wb) {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws);
      const list = document.getElementById("clientList" + capitalize(type));
      list.innerHTML = "";
      data.forEach((row, index) => {
        let key;
        if (type === 'residential') {
          key = `${row["שם פרטי"] || ""} ${row["שם משפחה"] || ""}`;
        } else if (type === 'business') {
          const companyName = row["שם חברה"] || "";
          const companyId = row["חפ"] || "";
          key = companyId ? `${companyName} (${companyId})` : companyName;
        } else if (type === 'affiliated') {
          const companyName = row["שם חברה"] || "";
          const companyId = row["ת.ז."] || "";
          key = companyId ? `${companyName} (${companyId})` : companyName;
        } else {
          key = `${row["שם"] || ""}`;
        }
        const option = new Option(key, index);
        list.appendChild(option);
      });
      adjustClientListHeight(type);
    }

    function filterClients(type) {
      const input = document.getElementById("searchInput" + capitalize(type)).value.toLowerCase();
      const list = document.getElementById("clientList" + capitalize(type));
      Array.from(list.options).forEach(option => {
        option.style.display = option.textContent.toLowerCase().includes(input) ? "block" : "none";
      });
      adjustClientListHeight(type);
    }

    async function loadClientData(type) {
      const list = document.getElementById("clientList" + capitalize(type));
      const index = list.selectedIndex;
      if (index === -1) return;

      const wb = type === 'residential' ? workbookResidential : type === 'business' ? workbookBusiness : type === 'interested' ? workbookInterested : workbookAffiliated;
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws);
      const row = data[index];

      if (type === 'residential') selectedIndexResidential = index;
      else if (type === 'business') selectedIndexBusiness = index;
      else if (type === 'interested') selectedIndexInterested = index;
      else if (type === 'affiliated') selectedIndexAffiliated = index;

      const form = document.getElementById("clientForm" + capitalize(type));
      form.innerHTML = "";

      const fileFieldNames = [
        "טופס איש קשר",
        "מתקני צרכן",
        "טופס מורשה חתימה",
        "תעודת התאגדות",
        "טופס הוראת קבע",
        "דוח נתוני צריכה"
      ];

      for (const key in row) {
        // דלג על עמודות שמסתיימות ב־" - קובץ" (אלה עמודות ממטפורציה של שמות קבצים)
        if (key.endsWith(" - קובץ")) continue;

        // בדוק אם זה שדה קובץ בלקוח עסקי
        const isFileField = type === 'business' && fileFieldNames.includes(key);

        if (isFileField) {
          // שדה קובץ
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.name = key + "_file";
          fileInput.id = key + "_file";
          fileInput.style.display = "none";

          const labelForUpload = document.createElement("label");
          labelForUpload.className = "upload-label";
          labelForUpload.htmlFor = fileInput.id;
          labelForUpload.textContent = "בחר קובץ";

          // הצגת שם הקובץ הקיים (אם יש)
          const existingName = row[key] || row[key + " - קובץ"] || "";
          const existingSpan = document.createElement("span");
          existingSpan.className = "upload-success";
          existingSpan.textContent = existingName ? `קיים: ${existingName}` : "אין קובץ";

          fileInput.addEventListener("change", () => {
            if (fileInput.files[0]) {
              labelForUpload.textContent = fileInput.files[0].name;
              existingSpan.textContent = `החדש: ${fileInput.files[0].name}`;
            }
          });

          // יצירת שורה שלמה עם כותרת + כפתור + שם
          const fileRowWrapper = document.createElement("div");
          fileRowWrapper.className = "file-row-wrapper";

          const label = document.createElement("div");
          label.className = "file-label";
          label.textContent = key;

          const controlsWrapper = document.createElement("div");
          controlsWrapper.className = "file-controls-wrapper";
          controlsWrapper.appendChild(fileInput);
          controlsWrapper.appendChild(labelForUpload);
          controlsWrapper.appendChild(existingSpan);

          fileRowWrapper.appendChild(label);
          fileRowWrapper.appendChild(controlsWrapper);
          form.appendChild(fileRowWrapper);
        } else if (type === 'interested' && key === "סטטוס") {
          // שדה סטטוס לאינטרסד
          const label = document.createElement("label");
          label.textContent = key;
          label.className = "label";
          form.appendChild(label);

          const select = document.createElement("select");
          select.className = "field";
          select.name = key;
          ["מתעניין", "חוזה שגוי", "חוזה חסר", "מונה חסר", "חוזה ומונה חסרים", "ת.ז שגוייה"].forEach(opt => {
            const o = new Option(opt, opt);
            if (row[key] === opt) o.selected = true;
            select.appendChild(o);
          });
          form.appendChild(select);
        } else if (key.includes("תאריך")) {
          // שדה תאריך
          const label = document.createElement("label");
          label.textContent = key;
          label.className = "label";
          form.appendChild(label);

          const input = document.createElement("input");
          input.type = "date";
          input.name = key;
          input.className = "field";
          input.value = row[key] || "";
          form.appendChild(input);
        } else {
          // שדה טקסט רגיל
          const label = document.createElement("label");
          label.textContent = key;
          label.className = "label";
          form.appendChild(label);

          const input = document.createElement("input");
          input.name = key;
          input.className = "field";
          input.value = row[key] || "";
          form.appendChild(input);
        }
      }
    }


    async function saveChanges(type) {
      const button = document.getElementById("saveBtn" + capitalize(type));
      const originalText = button.innerText;
      button.innerText = "שומר...";
      button.disabled = true;

      const wb = type === 'residential' ? workbookResidential : type === 'business' ? workbookBusiness : type === 'interested' ? workbookInterested : workbookAffiliated;
      const handle = type === 'residential' ? residentialFileHandle : type === 'business' ? businessFileHandle : type === 'interested' ? interestedFileHandle : affiliatedFileHandle;
      const idx = type === 'residential' ? selectedIndexResidential : type === 'business' ? selectedIndexBusiness : type === 'interested' ? selectedIndexInterested : selectedIndexAffiliated;

      if (!handle) {
        showPopup("יש לבחור קובץ אקסל לפני השמירה");
        button.innerText = originalText;
        button.disabled = false;
        return;
      }

      const ws = wb.Sheets[wb.SheetNames[0]];
      const allData = XLSX.utils.sheet_to_json(ws);
      if (idx === undefined || idx < 0 || idx >= allData.length) {
        showPopup("יש לבחור לקוח לפני שמירה");
        button.innerText = originalText;
        button.disabled = false;
        return;
      }

      const form = document.getElementById("clientForm" + capitalize(type));
      const inputs = form.querySelectorAll("input, select");
      const data = { ...allData[idx] };

      const fileInputs = [];

      inputs.forEach(input => {
        if (input.type === "file") {
          if (input.files.length > 0) fileInputs.push(input);
        } else {
          data[input.name] = input.value;
        }
      });

      if (type === 'business') {
        if (!businessFolderHandle) {
          showPopup("יש לבחור תיקיית שמירה קודם");
          button.innerText = originalText;
          button.disabled = false;
          return;
        }

        // שם התיקייה החדש בהתאם לנתונים המעודכנים
        const newFolderName = `${data["שם חברה"] || "ללא_שם"}_${data["חפ"] || "000"}`;
        
        // שם התיקייה הישנה בהתאם לנתונים הקודמים
        const existingRow = allData[idx];
        const oldFolderName = `${existingRow["שם חברה"] || "ללא_שם"}_${existingRow["חפ"] || "000"}`;

        // אם שם התיקייה השתנה - עדכן את שם התיקייה
        if (oldFolderName !== newFolderName) {
          try {
            // קבל את התיקייה הישנה
            const oldDir = await businessFolderHandle.getDirectoryHandle(oldFolderName);
            
            // צור את התיקייה החדשה
            const newDir = await businessFolderHandle.getDirectoryHandle(newFolderName, { create: true });
            
            // העתק את כל הקבצים מהתיקייה הישנה לחדשה
            for await (const entry of oldDir.entries()) {
              if (entry[1].kind === 'file') {
                const file = await entry[1].getFile();
                const fileHandle = await newDir.getFileHandle(entry[0], { create: true });
                const writableFile = await fileHandle.createWritable();
                await writableFile.write(await file.arrayBuffer());
                await writableFile.close();
              }
            }
            
            // מחק את התיקייה הישנה
            try {
              await businessFolderHandle.removeEntry(oldFolderName, { recursive: true });
            } catch (e) {
              console.warn(`לא ניתן למחוק את התיקייה הישנה: ${oldFolderName}`, e);
            }
          } catch (e) {
            console.warn(`לא ניתן לשנות שם תיקייה: ${oldFolderName} → ${newFolderName}`, e);
          }
        }

        const clientDir = await businessFolderHandle.getDirectoryHandle(newFolderName, { create: true });

        for (const fileInput of fileInputs) {
          const file = fileInput.files[0];
          const fieldName = fileInput.name.replace("_file", "");

          // גישה רברסיבית למפתח קיים (התחשבות בכל פורמט אפשרי בעמודת האקסל)
          const possibleKeys = [fieldName, fieldName + " - קובץ"];
          const existingKey = possibleKeys.find(k => existingRow[k] !== undefined) || fieldName;

          // אם קיים קובץ קודם - מחיקה
          if (existingRow[existingKey]) {
            try {
              await clientDir.removeEntry(existingRow[existingKey]);
            } catch (e) {
              console.warn(`לא ניתן למחוק את הקובץ הישן: ${existingRow[existingKey]}`, e);
            }
          }

          // שמירת הקובץ החדש
          const fileHandle = await clientDir.getFileHandle(file.name, { create: true });
          const writableFile = await fileHandle.createWritable();
          await writableFile.write(await file.arrayBuffer());
          await writableFile.close();

          // עדכון שדה באקסל בעזרת המפתח הקיים או השם הראשוני
          data[existingKey] = file.name;
        }
      }

      allData[idx] = data;
      const newSheet = XLSX.utils.json_to_sheet(allData);
      wb.Sheets[wb.SheetNames[0]] = newSheet;

      // כתיבה בצורה של ArrayBuffer (עקבי עם businessCust.html)
      const updatedArrayBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const writable = await handle.createWritable();
      await writable.write(updatedArrayBuffer);
      await writable.close();

      // עדכון הרשימה הנפתחת כדי להשקף את השינויים
      populateClientList(type, wb);

      button.innerText = originalText;
      button.disabled = false;
      showPopup("הנתונים נשמרו בהצלחה.");
    }


    function capitalize(txt) {
      return txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    function adjustClientListHeight(type) {
      const list = document.getElementById("clientList" + capitalize(type));
      const visibleOptions = Array.from(list.options).filter(option => option.style.display !== "none");
      const rowHeight = 38;
      const maxVisible = 5;
      const height = Math.min(visibleOptions.length, maxVisible) * rowHeight;
      list.style.height = height + "px";
    }
    function showPopup(msg) {
      const popup = document.getElementById("popup");
      const popupText = document.getElementById("popupText");
      popupText.textContent = msg;
      popup.classList.remove("hidden");
      popup.focus();
    }

    function closePopup() {
      document.getElementById("popup").classList.add("hidden");
    }

    document.getElementById("popup").addEventListener("keydown", function (e) {
      if (e.key === "Enter") closePopup();
    });

  </script>
</body>

</html>