<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>תיקון פרטי לקוח</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <img src="logo.JPG" alt="לוגו">
    </div>
    <div class="upload-section">
      <button type="button" id="uploadButton" class="choose-excel">בחר קובץ אקסל</button>
    </div>


    <h2>תיקון פרטי לקוח</h2>

    <label class="label" for="searchInput">חפש לפי שם פרטי או משפחה:</label>
    <input type="text" id="searchInput" class="field" placeholder="הקלד שם...">

    <select id="clientList" class="field"></select>


    <div id="clientDetails" class="client-details card"></div>

    <button id="saveButton">שמירה</button>

    <div id="popup" class="popup hidden">
      <p id="popupText"></p>
      <button onclick="closePopup()">אישור</button>
    </div>
  </div>

  <script>
    let selectedFileHandle;
    let workbookData = [];

    function showAlert(message) {
      document.getElementById("popupText").innerText = message;
      document.getElementById("popup").classList.remove("hidden");
    }

    function closePopup() {
      document.getElementById("popup").classList.add("hidden");
    }
function populateClientList() {
  const list = document.getElementById('clientList');
  list.innerHTML = "";
  const search = document.getElementById('searchInput').value.toLowerCase();
  let matchedCount = 0;

  // הוספת אופציות לכל הלקוחות שמתאימים לחיפוש
  workbookData.slice(1).forEach((row, index) => {
    const fullName = `${row[1] || ""} ${row[2] || ""}`.trim();
    if (fullName.includes(search)) {
      const option = document.createElement('option');
      option.value = index + 1;
      option.textContent = fullName;
      list.appendChild(option);
      matchedCount++;
    }
  });

  // אם אין תוצאות, נסתר את הרשימה
  if (matchedCount === 0) {
    list.style.display = 'none';
  } else {
    list.style.display = 'block';
    // קביעת גובה הרשימה - עד 5 אפשרויות תצוגה
    list.size = Math.min(matchedCount, 5);
  }

  // אם יש רק לקוח אחד, בחר אותו אוטומטית
  if (matchedCount === 1) {
    list.selectedIndex = 0;
    list.dispatchEvent(new Event("change"));
  }
}


    document.getElementById("searchInput").addEventListener("input", populateClientList);

    document.getElementById("clientList").addEventListener("change", function () {
      const index = this.value;
      const row = workbookData[index];
      const container = document.getElementById("clientDetails");
      container.innerHTML = "";
      if (!row) return;

      const headers = workbookData[0];
      row.forEach((cell, i) => {
        const label = headers[i] || `שדה ${i + 1}`;
        const input = document.createElement("input");
        input.value = cell || "";
        input.dataset.index = i;
        input.className = "field";

        const wrapper = document.createElement("div");
        wrapper.className = "field-wrapper";
        wrapper.innerHTML = `<div class="label">${label}:</div>`;
        wrapper.appendChild(input);

        container.appendChild(wrapper);
      });
    });

    document.getElementById("saveButton").addEventListener("click", async () => {
      const selected = document.getElementById("clientList").value;
      if (!selected) {
        showAlert("לא נבחר לקוח");
        return;
      }

      const inputs = document.querySelectorAll("#clientDetails input");
      inputs.forEach(input => {
        const colIndex = parseInt(input.dataset.index);
        workbookData[selected][colIndex] = input.value;
      });

      try {
        const worksheet = XLSX.utils.aoa_to_sheet(workbookData);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, worksheet, "Sheet1");
        const wbout = XLSX.write(newWorkbook, { bookType: "xlsx", type: "array" });
        const writable = await selectedFileHandle.createWritable();
        await writable.write(wbout);
        await writable.close();
        showAlert("הנתונים נשמרו בהצלחה");
      } catch (error) {
        showAlert("שגיאה בשמירה: " + error.message);
      }
    });

    document.getElementById("uploadButton").addEventListener("click", async () => {
      try {
        [selectedFileHandle] = await window.showOpenFilePicker();
        const file = await selectedFileHandle.getFile();
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        workbookData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        populateClientList();
        showAlert("הקובץ נטען בהצלחה");
      } catch (err) {
        showAlert("שגיאה בטעינת קובץ: " + err.message);
      }
    });

    document.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !document.getElementById("popup").classList.contains("hidden")) {
        closePopup();
      }
    });
  </script>
</body>

</html>