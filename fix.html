<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>תיקון נתוני לקוח</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="logo3.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .active {
      background-color: var(--primary);
      color: white;
    }

    .upload-success {
      color: green;
      font-size: 14px;
      margin-top: 4px;
    }
  </style>
</head>

<body onload="switchTab('residential')">
  <div class="container">
    <div class="header"><img src="logo.JPG" alt="לוגו"></div>

    <div class="tabs">
      <button id="tabBtnResidential" class="tab-button active-tab" onclick="switchTab('residential')">לקוח ביתי</button>
      <button id="tabBtnBusiness" class="tab-button" onclick="switchTab('business')">לקוח עסקי</button>
      <button id="tabBtnInterested" class="tab-button" onclick="switchTab('interested')">לקוח מתעניין</button>
    </div>

    <div id="residentialTab">
      <button type="button" onclick="chooseExcelResidential()" class="choose-excel">בחר קובץ אקסל</button>
      <input type="text" id="searchInputResidential" class="field" placeholder="חפש לפי שם פרטי או משפחה"
        oninput="filterClients('residential')">
      <div class="client-list-wrapper"><select id="clientListResidential" class="client-select" size="5"
          onchange="loadClientData('residential')"></select></div>
      <form id="clientFormResidential"></form>
      <button id="saveBtnResidential" type="button" onclick="saveChanges('residential')">שמור שינויים</button>
    </div>

    <div id="businessTab" class="hidden">
      <button type="button" onclick="chooseExcelBusiness()" class="choose-excel">בחר קובץ אקסל</button>
      <button type="button" onclick="chooseBusinessFolder()" class="choose-excel">בחר תיקיית שמירה</button>
      <input type="text" id="searchInputBusiness" class="field" placeholder="חפש לפי שם חברה או ת.ז."
        oninput="filterClients('business')">
      <div class="client-list-wrapper"><select id="clientListBusiness" class="client-select" size="5"
          onchange="loadClientData('business')"></select></div>
      <form id="clientFormBusiness"></form>
      <button id="saveBtnBusiness" type="button" onclick="saveChanges('business')">שמור שינויים</button>
    </div>

    <div id="interestedTab" class="hidden">
      <button type="button" onclick="chooseExcelInterested()" class="choose-excel">בחר קובץ אקסל</button>
      <input type="text" id="searchInputInterested" class="field" placeholder="חפש לפי שם"
        oninput="filterClients('interested')">
      <div class="client-list-wrapper"><select id="clientListInterested" class="client-select" size="5"
          onchange="loadClientData('interested')"></select></div>
      <form id="clientFormInterested"></form>
      <button id="saveBtnInterested" type="button" onclick="saveChanges('interested')">שמור שינויים</button>
    </div>

    <div id="popup" class="popup hidden" tabindex="0">
      <p id="popupText"></p>
      <button onclick="closePopup()">אישור</button>
    </div>
  </div>

  <script>
    let workbookResidential, selectedIndexResidential;
    let workbookBusiness, selectedIndexBusiness;
    let workbookInterested, selectedIndexInterested;
    let residentialFileHandle, businessFileHandle, interestedFileHandle;
    let businessFolderHandle;

    function switchTab(tab) {
      ["residential", "business", "interested"].forEach(t => {
        document.getElementById(t + "Tab").style.display = t === tab ? 'block' : 'none';
        document.getElementById("tabBtn" + capitalize(t)).classList.toggle("active-tab", t === tab);
      });
    }

    async function chooseExcelResidential() {
      [residentialFileHandle] = await window.showOpenFilePicker();
      const file = await residentialFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookResidential = XLSX.read(data);
      populateClientList("residential", workbookResidential);
    }

    async function chooseExcelBusiness() {
      [businessFileHandle] = await window.showOpenFilePicker();
      const file = await businessFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookBusiness = XLSX.read(data);
      populateClientList("business", workbookBusiness);
    }

    async function chooseExcelInterested() {
      [interestedFileHandle] = await window.showOpenFilePicker();
      const file = await interestedFileHandle.getFile();
      const data = await file.arrayBuffer();
      workbookInterested = XLSX.read(data);
      populateClientList("interested", workbookInterested);
    }

    async function chooseBusinessFolder() {
      businessFolderHandle = await window.showDirectoryPicker();
    }

    function populateClientList(type, wb) {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws);
      const list = document.getElementById("clientList" + capitalize(type));
      list.innerHTML = "";
      data.forEach((row, index) => {
        const key = type === 'residential' ? `${row["שם פרטי"] || ""} ${row["שם משפחה"] || ""}` : type === 'business' ? `${row["שם חברה"] || ""} ${row["ת.ז."] || ""}` : `${row["שם"] || ""}`;
        const option = new Option(key, index);
        list.appendChild(option);
      });
      adjustClientListHeight(type);
    }

    function filterClients(type) {
      const input = document.getElementById("searchInput" + capitalize(type)).value.toLowerCase();
      const list = document.getElementById("clientList" + capitalize(type));
      Array.from(list.options).forEach(option => {
        option.style.display = option.textContent.toLowerCase().includes(input) ? "block" : "none";
      });
      adjustClientListHeight(type);
    }

   function loadClientData(type) {
  const list = document.getElementById("clientList" + capitalize(type));
  const index = list.selectedIndex;
  if (index === -1) return;

  const wb = type === 'residential' ? workbookResidential : type === 'business' ? workbookBusiness : workbookInterested;
  const ws = wb.Sheets[wb.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(ws);
  const row = data[index];

  if (type === 'residential') selectedIndexResidential = index;
  else if (type === 'business') selectedIndexBusiness = index;
  else selectedIndexInterested = index;

  const form = document.getElementById("clientForm" + capitalize(type));
  form.innerHTML = "";

  const fileFieldNames = [
    "טופס איש קשר",
    "מתקני צרכן",
    "טופס מורשה חתימה",
    "תעודת התאגדות",
    "טופס הוראת קבע",
    "דוח נתוני צריכה"
  ];

  for (const key in row) {
    const label = document.createElement("label");
    label.textContent = key;
    label.className = "label";
    form.appendChild(label);

    if (type === 'interested' && key === "סטטוס") {
      const select = document.createElement("select");
      select.className = "field";
      select.name = key;
      ["חדש", "נשלח הצעה", "בהמתנה", "סגור", "לא רלוונטי"].forEach(opt => {
        const o = new Option(opt, opt);
        if (row[key] === opt) o.selected = true;
        select.appendChild(o);
      });
      form.appendChild(select);
    } else {
      const input = document.createElement("input");
      input.name = key;
      input.className = "field";
      input.value = row[key];
      form.appendChild(input);
    }

    // העלאת קובץ רק לשדות הרלוונטיים
    if (type === 'business' && fileFieldNames.includes(key)) {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "8px";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.name = key + "_file";
      fileInput.id = key + "_file";
      fileInput.style.display = "none";

      const labelForUpload = document.createElement("label");
      labelForUpload.className = "upload-label";
      labelForUpload.htmlFor = fileInput.id;
      labelForUpload.textContent = "בחר קובץ";

      fileInput.addEventListener("change", () => {
        labelForUpload.textContent = fileInput.files[0]?.name || "בחר קובץ";
      });

      wrapper.appendChild(fileInput);
      wrapper.appendChild(labelForUpload);
      form.appendChild(wrapper);
    }
  }
}


  async function saveChanges(type) {
  const button = document.getElementById("saveBtn" + capitalize(type));
  const originalText = button.innerText;
  button.innerText = "שומר...";
  button.disabled = true;

  const wb = type === 'residential' ? workbookResidential : type === 'business' ? workbookBusiness : workbookInterested;
  const handle = type === 'residential' ? residentialFileHandle : type === 'business' ? businessFileHandle : interestedFileHandle;
  const idx = type === 'residential' ? selectedIndexResidential : type === 'business' ? selectedIndexBusiness : selectedIndexInterested;

  if (!handle) {
    showPopup("יש לבחור קובץ אקסל לפני השמירה");
    button.innerText = originalText;
    button.disabled = false;
    return;
  }

  const ws = wb.Sheets[wb.SheetNames[0]];
  const allData = XLSX.utils.sheet_to_json(ws);
  if (idx === undefined || idx < 0 || idx >= allData.length) {
    showPopup("יש לבחור לקוח לפני שמירה");
    button.innerText = originalText;
    button.disabled = false;
    return;
  }

  const form = document.getElementById("clientForm" + capitalize(type));
  const inputs = form.querySelectorAll("input, select");
  const data = { ...allData[idx] };

  const fileInputs = [];

  inputs.forEach(input => {
    if (input.type === "file") {
      if (input.files.length > 0) fileInputs.push(input);
    } else {
      data[input.name] = input.value;
    }
  });

  if (type === 'business') {
    if (!businessFolderHandle) {
      showPopup("יש לבחור תיקיית שמירה קודם");
      button.innerText = originalText;
      button.disabled = false;
      return;
    }

    const folderName = `${data["שם חברה"] || "ללא_שם"}_${data["חפ"] || "000"}`;
    const clientDir = await businessFolderHandle.getDirectoryHandle(folderName, { create: true });

    const existingRow = allData[idx];

    for (const fileInput of fileInputs) {
      const file = fileInput.files[0];
      const fieldName = fileInput.name.replace("_file", "");
      const fileFieldKey = fieldName + " - קובץ";

      // אם קיים קובץ קודם - מחיקה
      if (existingRow[fileFieldKey]) {
        try {
          await clientDir.removeEntry(existingRow[fileFieldKey]);
        } catch (e) {
          console.warn(`לא ניתן למחוק את הקובץ הישן: ${existingRow[fileFieldKey]}`, e);
        }
      }

      // שמירת הקובץ החדש
      const fileHandle = await clientDir.getFileHandle(file.name, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(await file.arrayBuffer());
      await writable.close();

      // עדכון שדה באקסל
      data[fileFieldKey] = file.name;
    }
  }

  allData[idx] = data;
  const newSheet = XLSX.utils.json_to_sheet(allData);
  wb.Sheets[wb.SheetNames[0]] = newSheet;

  const binaryString = XLSX.write(wb, { bookType: "xlsx", type: "binary" });
  const buffer = new ArrayBuffer(binaryString.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binaryString.length; ++i) view[i] = binaryString.charCodeAt(i) & 0xFF;

  const blob = new Blob([buffer], { type: "application/octet-stream" });
  const writable = await handle.createWritable();
  await writable.write(blob);
  await writable.close();

  button.innerText = originalText;
  button.disabled = false;
  showPopup("הנתונים נשמרו בהצלחה.");
}


    function capitalize(txt) {
      return txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    function adjustClientListHeight(type) {
      const list = document.getElementById("clientList" + capitalize(type));
      const visibleOptions = Array.from(list.options).filter(option => option.style.display !== "none");
      const rowHeight = 38;
      const maxVisible = 5;
      const height = Math.min(visibleOptions.length, maxVisible) * rowHeight;
      list.style.height = height + "px";
    }
    function showPopup(msg) {
      const popup = document.getElementById("popup");
      const popupText = document.getElementById("popupText");
      popupText.textContent = msg;
      popup.classList.remove("hidden");
      popup.focus();
    }

    function closePopup() {
      document.getElementById("popup").classList.add("hidden");
    }

    document.getElementById("popup").addEventListener("keydown", function (e) {
      if (e.key === "Enter") closePopup();
    });

  </script>
</body>

</html>